<div class="page-container">
  <header class="header">
    <div class="brand" (click)="goDashboard()">
      <img src="assets/logo.webp" class="logo" alt="Logo tr∆∞·ªùng" />
      <div class="brand-text">
        <div class="brand-name">ƒê·∫†I H·ªåC X√ÇY D·ª∞NG</div>
        <div class="brand-sub">Dashboard</div>
      </div>
    </div>
    <div class="header-right">
      <button class="bell" aria-label="Th√¥ng b√°o">üîî</button>
      <div class="user">
        <div class="user-name">{{ principal.name }}</div>
        <div class="avatar"></div>
      </div>
    </div>
  </header>

  <app-sidebar
    [sidebarOpen]="sidebarOpen"
    (toggleSidebarEvent)="toggleSidebar()"
  ></app-sidebar>

  <div class="form-card">
    <div class="form-header">
      <h2>T·∫°o KPI</h2>
    </div>

    <section class="form-section">
      <div class="field-row">
        <div class="form-field full-width">
          <label>Ch·ªçn Template</label>
          <div class="input-with-button">
            <select
              [(ngModel)]="selectedTemplateId"
              (change)="onTemplateChange()"
            >
              <option [value]="null" disabled selected>
                -- Ch·ªçn Template c√≥ s·∫µn --
              </option>
              <option *ngFor="let t of templates" [value]="t.id">
                {{ t.templateName }}
              </option>
            </select>
            <button class="btn-create" (click)="openNewTemplate()">
              + T·∫°o m·ªõi
            </button>
          </div>
        </div>
      </div>
      <div class="new-template-form" *ngIf="showNewTemplateForm">
        <div class="form-field">
          <label>T√™n Template m·ªõi</label>
          <input
            [(ngModel)]="newTemplate.templateName"
            placeholder="T√™n template"
          />
        </div>
        <div class="form-field">
          <label>M√¥ t·∫£ Template</label>
          <textarea
            [(ngModel)]="newTemplate.description"
            placeholder="M√¥ t·∫£"
          ></textarea>
        </div>
        <div class="form-actions-template">
          <button class="btn btn-cancel" (click)="cancelNewTemplate()">
            H·ª¶Y
          </button>
          <button class="btn btn-primary" (click)="createTemplate()">
            L∆ØU
          </button>
        </div>
      </div>
    </section>
    <section class="form-section">
      <div class="field-row">
        <div class="form-field full-width">
          <label>Ti√™u ƒë·ªÅ KPI</label>
          <input
            [(ngModel)]="item.kpiName"
            placeholder="Ho√†n th√†nh b√°o c√°o t√¨nh h√¨nh gi·∫£ng d·∫°y"
          />
        </div>
      </div>
      <div class="field-row">
        <div class="form-field half-width">
          <label>Lo·∫°i KPI</label>
          <select [(ngModel)]="item.kpiType">
            <option value="Ch·ª©c nƒÉng">Ch·ª©c nƒÉng</option>
            <option value="M·ª•c ti√™u">M·ª•c ti√™u</option>
            <option value="Tu√¢n th·ªß">Tu√¢n th·ªß</option>
          </select>
        </div>
        <div class="form-field half-width">
          <label>Th·ªùi gian k·∫øt th√∫c</label>
          <input type="date" [(ngModel)]="item.deadLine" />
        </div>
      </div>
      <div class="field-row">
        <div class="form-field half-width">
          <label>C√¥ng th·ª©c t√≠nh</label>
          <input
            [(ngModel)]="item.calculationFormula"
            placeholder="VD: (Gi√° tr·ªã th·ª±c t·∫ø x Tr·ªçng s·ªë)/M·ª•c ti√™u"
          />
        </div>
        <div class="form-field half-width">
          <label>Tr·ªçng s·ªë</label>
          <input type="number" [(ngModel)]="item.weight" placeholder="5" />
        </div>
      </div>
    </section>

    <div class="form-actions">
      <button class="btn btn-cancel" (click)="goDashboard()">H·ª¶Y</button>
      <button class="btn btn-primary" (click)="createItem()">TI·∫æP</button>
    </div>

    <!-- //KP ƒë√£ t·∫°o -->

    <div class="created-kpis-card">
      <h3>C√°c KPI ƒë√£ t·∫°o</h3>
      <div class="kpi-list-container">
        <div class="template-list">
          <h4>Template ƒë√£ t·∫°o</h4>
          <ul>
            <li
              *ngFor="let t of templates"
              (click)="loadItemsByTemplate(t.id)"
              [ngClass]="{ 'active-template': t.id === selectedTemplateId }"
            >
              {{ t.templateName }}
            </li>
          </ul>
        </div>
        <div class="item-list" *ngIf="selectedTemplateId">
          <h4>C√°c m·ª•c ti√™u trong Template</h4>
          <div *ngIf="itemsByTemplate.length > 0; else noItems">
            <div class="item-card" *ngFor="let item of itemsByTemplate">
              <h5>{{ item.kpiName }}</h5>
              <p><strong>Lo·∫°i:</strong> {{ item.kpiType }}</p>
              <p>
                <strong>H·∫°n ch√≥t:</strong>
                {{ item.deadLine | date : "dd/MM/yyyy" }}
              </p>
              <p><strong>Tr·ªçng s·ªë:</strong> {{ item.weight }}</p>
              <div class="item-actions">
                <button class="btn btn-edit" (click)="editItem(item)">
                  S·ª≠a
                </button>
                <button class="btn btn-delete" (click)="deleteItem(item.id)">
                  X√≥a
                </button>
              </div>
            </div>
          </div>
          <ng-template #noItems>
            <p class="no-items-message">
              Ch∆∞a c√≥ m·ª•c ti√™u n√†o trong template n√†y.
            </p>
          </ng-template>
        </div>

        <div class="form-card" *ngIf="isEditing">
          <div class="form-header">
            <h2>S·ª≠a KPI</h2>
          </div>

          <section class="form-section">
            <div class="field-row">
              <div class="form-field full-width">
                <label>Ti√™u ƒë·ªÅ KPI</label>
                <input
                  [(ngModel)]="editingItem.kpiName"
                  placeholder="Ho√†n th√†nh b√°o c√°o t√¨nh h√¨nh gi·∫£ng d·∫°y"
                />
              </div>
            </div>
            <div class="field-row">
              <div class="form-field half-width">
                <label>Lo·∫°i KPI</label>
                <select [(ngModel)]="editingItem.kpiType">
                  <option value="Ch·ª©c nƒÉng">Ch·ª©c nƒÉng</option>
                  <option value="M·ª•c ti√™u">M·ª•c ti√™u</option>
                  <option value="Tu√¢n th·ªß">Tu√¢n th·ªß</option>
                </select>
              </div>
              <div class="form-field half-width">
                <label>Th·ªùi gian k·∫øt th√∫c</label>
                <input type="date" [(ngModel)]="editingItem.deadLine" />
              </div>
            </div>
            <div class="field-row">
              <div class="form-field half-width">
                <label>C√¥ng th·ª©c t√≠nh</label>
                <input
                  [(ngModel)]="editingItem.calculationFormula"
                  placeholder="VD: (Gi√° tr·ªã th·ª±c t·∫ø x Tr·ªçng s·ªë)/M·ª•c ti√™u"
                />
              </div>
              <div class="form-field half-width">
                <label>Tr·ªçng s·ªë</label>
                <input
                  type="number"
                  [(ngModel)]="editingItem.weight"
                  placeholder="5"
                />
              </div>
            </div>
          </section>

          <div class="form-actions">
            <button class="btn btn-cancel" (click)="cancelEdit()">H·ª¶Y</button>
            <button class="btn btn-primary" (click)="updateItem()">L∆ØU</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
