<div class="page-container">
  <app-topbar></app-topbar>
  <app-sidebar
    [sidebarOpen]="sidebarOpen"
    (toggleSidebarEvent)="toggleSidebar()"
  ></app-sidebar>

  <div class="form-card">
    <div class="form-header">
      <h2>Giao KPI</h2>
    </div>

    <section class="form-section">
      <div class="field-row">
        <div class="form-field half-width">
          <label>Người nhận KPI</label>
          <select [(ngModel)]="selectedUserId" (ngModelChange)="onUserChange()">
            <option [ngValue]="0" disabled selected>-- Chọn người nhận --</option>
            <option *ngFor="let u of users" [ngValue]="u.id">
              {{ u.fullName }}
            </option>
          </select>
        </div>

        <div class="form-field half-width">
          <label>Đơn vị</label>
          <select [(ngModel)]="selectedUnitId">
            <option [ngValue]="0" disabled selected>-- Chọn đơn vị --</option>
            <option
              *ngIf="selectedUserId !== 0 && filteredUnits.length === 0"
              [value]="0"
              disabled
            >
              {{ selectedUserUnitName }}
            </option>
            <option *ngFor="let u of filteredUnits" [ngValue]="u.id">
              {{ u.name }}
            </option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="form-field full-width">
          <label>Chọn Template</label>
          <select [(ngModel)]="selectedTemplateId" (change)="onTemplateChange()">
            <option [ngValue]="null" disabled selected>-- Chọn Template có sẵn --</option>
            <option *ngFor="let t of templates" [ngValue]="t.id">
              {{ t.templateName }} ({{ t.year }})
            </option>
          </select>
        </div>
      </div>

      <div *ngIf="selectedTemplateId !== null" class="kpi-items-selection">
        <h4>Các mục tiêu trong Template</h4>
        <div class="item-list">
          <div *ngFor="let item of itemsByTemplate" class="item-card">
            <div class="item-details">
              <input type="checkbox"
                     [checked]="item.isSelected"
                     (change)="onItemSelectionChange(item.id, $event)"
              />
              <div class="item-text">
                <p><strong>{{ item.kpiName }}</strong></p>
                <p>Loại: {{ item.kpiType }}</p>
              </div>
            </div>
          </div>
          <p *ngIf="itemsByTemplate.length === 0" class="no-items-message">
            Chưa có mục tiêu nào trong template này.
          </p>
        </div>
      </div>
    </section>

    <section class="form-section">
      <h3>Thông tin chung</h3>
      <div class="field-row">
        <div class="form-field third-width">
          <label>Năm</label>
          <input type="number" [(ngModel)]="selectedYear" />
        </div>
        <div class="form-field third-width">
          <label>Trọng số đóng góp (%)</label>
          <input type="number" [(ngModel)]="contributionWeight" placeholder="Để trống nếu dùng trọng số gốc"/>
        </div>
      </div>
    </section>

    <div class="btn">
      <button (click)="assignKpis()">Giao KPI</button>
    </div>
  </div>
</div>
